name: Deploy Image Service (Manual)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        type: choice
        required: true
        options:
          - production
          - staging
          - preview
        default: production

jobs:
  deploy:
    environment: ${{ inputs.environment }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Deploy image service
        working-directory: packages/doggy-nav-image-service
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          R2_BUCKET_NAME: ${{ vars.R2_BUCKET_NAME }}
          # Non-secret vars from environment
          IMAGES_PUBLIC_URL: ${{ vars.IMAGES_PUBLIC_URL }}
          ALLOWED_ORIGINS: ${{ vars.ALLOWED_ORIGINS }}
          IMAGE_MAX_SIZE_MB: ${{ vars.IMAGE_MAX_SIZE_MB }}
          IMAGE_USER_QUOTA_MB: ${{ vars.IMAGE_USER_QUOTA_MB }}
        run: |
          set -euo pipefail

          # Substitute R2 bucket name in wrangler config
          if [ -z "${R2_BUCKET_NAME:-}" ]; then
            echo "Error: R2_BUCKET_NAME variable is required"
            exit 1
          fi
          sed -i "s/PLACEHOLDER_R2_BUCKET/${R2_BUCKET_NAME}/g" wrangler.jsonc

          add_var() { local k="$1"; local v="${2:-}"; if [ -n "$v" ]; then VARS+=(--var "$k:$v"); fi }
          declare -a VARS=()
          add_var IMAGES_PUBLIC_URL "${IMAGES_PUBLIC_URL:-}"
          add_var ALLOWED_ORIGINS "${ALLOWED_ORIGINS:-}"
          add_var IMAGE_MAX_SIZE_MB "${IMAGE_MAX_SIZE_MB:-}"
          add_var IMAGE_USER_QUOTA_MB "${IMAGE_USER_QUOTA_MB:-}"

          KEEP_FLAG=""
          if pnpm exec wrangler deploy --help | grep -q -- "--keep-vars"; then
            KEEP_FLAG="--keep-vars"
          fi

          if [ ${#VARS[@]} -eq 0 ]; then
            pnpm exec wrangler deploy
          else
            pnpm exec wrangler deploy ${KEEP_FLAG} "${VARS[@]}"
          fi
