name: Deploy Workers (Manual)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        type: choice
        required: true
        options:
          - production
          - staging
          - preview
        default: production
      db_name:
        description: 'Override D1 DB name (optional)'
        required: false
        type: string
      db_id:
        description: 'Override D1 DB id (optional)'
        required: false
        type: string

jobs:
  deploy:
    environment: ${{ inputs.environment }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Resolve D1 variables
        env:
          # Prefer workflow inputs; fallback to environment vars, then secrets
          INPUT_DB_NAME: ${{ inputs.db_name }}
          INPUT_DB_ID: ${{ inputs.db_id }}
          CF_D1_DB_NAME: ${{ vars.CF_D1_DB_NAME }}
          CF_D1_DB_ID: ${{ vars.CF_D1_DB_ID }}
        run: |
          set -euo pipefail
          DB_NAME="${INPUT_DB_NAME:-$CF_D1_DB_NAME}"
          DB_ID="${INPUT_DB_ID:-$CF_D1_DB_ID}"
          if [ -z "${DB_NAME:-}" ]; then
            echo "D1 database name not provided. Use input 'db_name' or set CF_D1_DB_NAME in environment" >&2
            exit 1
          fi
          if [ -z "${DB_ID:-}" ]; then
            echo "D1 database id not provided. Use input 'db_id' or set CF_D1_DB_ID in environment" >&2
            exit 1
          fi
          echo "D1_DATABASE_NAME=$DB_NAME" >> "$GITHUB_ENV"
          echo "D1_DATABASE_ID=$DB_ID" >> "$GITHUB_ENV"

      - name: Inject D1 vars into wrangler.jsonc
        working-directory: packages/doggy-nav-workers
        run: |
          set -euo pipefail
          # Escape sed replacement specials
          RNAME=$(printf '%s' "$D1_DATABASE_NAME" | sed -e 's/[&\/]/\\&/g')
          RID=$(printf '%s' "$D1_DATABASE_ID" | sed -e 's/[&\/]/\\&/g')
          sed -i "s|\${D1_DATABASE_NAME}|$RNAME|g" wrangler.jsonc
          sed -i "s|\${D1_DATABASE_ID}|$RID|g" wrangler.jsonc
          echo 'Updated wrangler.jsonc D1 config:'
          grep -n "database_\(name\|id\)" wrangler.jsonc || true

      - name: Apply D1 migrations (remote)
        working-directory: packages/doggy-nav-workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          set -euo pipefail
          echo "Applying migrations to D1 database ($D1_DATABASE_NAME) on account: $CLOUDFLARE_ACCOUNT_ID"
          pnpm exec wrangler d1 migrations apply "$D1_DATABASE_NAME" --remote

      - name: Deploy worker
        working-directory: packages/doggy-nav-workers
        run: pnpm exec wrangler deploy

        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
