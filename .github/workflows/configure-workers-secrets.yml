name: Configure Worker Secrets (Manual)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        type: choice
        required: true
        options:
          - production
          - staging
          - preview
        default: production

jobs:
  configure:
    environment: ${{ inputs.environment }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps (to get wrangler from devDependencies)
        run: pnpm install --frozen-lockfile

      - name: Set Worker secrets (skips if a secret is missing)
        working-directory: packages/doggy-nav-workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          SEED_TOKEN: ${{ secrets.SEED_TOKEN }}
          GITHUB_CLIENT_SECRET: ${{ secrets.GITHUB_CLIENT_SECRET }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          LINUXDO_CLIENT_SECRET: ${{ secrets.LINUXDO_CLIENT_SECRET }}
        run: |
          set -euo pipefail
          if [ -n "${JWT_SECRET:-}" ]; then echo "$JWT_SECRET" | pnpm exec wrangler secret put JWT_SECRET --yes; else echo "JWT_SECRET not set; skipping"; fi
          if [ -n "${SEED_TOKEN:-}" ]; then echo "$SEED_TOKEN" | pnpm exec wrangler secret put SEED_TOKEN --yes; else echo "SEED_TOKEN not set; skipping"; fi
          if [ -n "${GITHUB_CLIENT_SECRET:-}" ]; then echo "$GITHUB_CLIENT_SECRET" | pnpm exec wrangler secret put GITHUB_CLIENT_SECRET --yes; else echo "GITHUB_CLIENT_SECRET not set; skipping"; fi
          if [ -n "${GOOGLE_CLIENT_SECRET:-}" ]; then echo "$GOOGLE_CLIENT_SECRET" | pnpm exec wrangler secret put GOOGLE_CLIENT_SECRET --yes; else echo "GOOGLE_CLIENT_SECRET not set; skipping"; fi
          if [ -n "${LINUXDO_CLIENT_SECRET:-}" ]; then echo "$LINUXDO_CLIENT_SECRET" | pnpm exec wrangler secret put LINUXDO_CLIENT_SECRET --yes; else echo "LINUXDO_CLIENT_SECRET not set; skipping"; fi

      - name: Set Worker vars (skips if a var is missing)
        working-directory: packages/doggy-nav-workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          # Non-secret toggles
          ALLOWED_ORIGINS: ${{ vars.ALLOWED_ORIGINS }}
          RATE_LIMIT_MAX: ${{ vars.RATE_LIMIT_MAX }}
          RATE_LIMIT_WINDOW_MS: ${{ vars.RATE_LIMIT_WINDOW_MS }}
          NODE_ENV: ${{ vars.NODE_ENV }}
          PUBLIC_BASE_URL: ${{ vars.PUBLIC_BASE_URL }}
          REQUIRE_INVITE_CODE: ${{ vars.REQUIRE_INVITE_CODE }}
          # GitHub OAuth (non-secret here)
          GITHUB_CLIENT_ID: ${{ vars.GITHUB_CLIENT_ID }}
          GITHUB_CALLBACK_URL: ${{ vars.GITHUB_CALLBACK_URL }}
          # Google OAuth
          GOOGLE_CLIENT_ID: ${{ vars.GOOGLE_CLIENT_ID }}
          GOOGLE_CALLBACK_URL: ${{ vars.GOOGLE_CALLBACK_URL }}
          # LinuxDo OAuth
          LINUXDO_CLIENT_ID: ${{ vars.LINUXDO_CLIENT_ID }}
          LINUXDO_CALLBACK_URL: ${{ vars.LINUXDO_CALLBACK_URL }}
          LINUXDO_AUTHORIZATION_URL: ${{ vars.LINUXDO_AUTHORIZATION_URL }}
          LINUXDO_TOKEN_URL: ${{ vars.LINUXDO_TOKEN_URL }}
          LINUXDO_PROFILE_URL: ${{ vars.LINUXDO_PROFILE_URL }}
          LINUXDO_SCOPE: ${{ vars.LINUXDO_SCOPE }}
        run: |
          set -euo pipefail
          set_var() { local k="$1"; local v="$2"; if [ -n "$v" ]; then pnpm exec wrangler vars set "$k" "$v" --yes; else echo "$k not set; skipping"; fi }
          set_var ALLOWED_ORIGINS "${ALLOWED_ORIGINS:-}"
          set_var RATE_LIMIT_MAX "${RATE_LIMIT_MAX:-}"
          set_var RATE_LIMIT_WINDOW_MS "${RATE_LIMIT_WINDOW_MS:-}"
          set_var NODE_ENV "${NODE_ENV:-}"
          set_var PUBLIC_BASE_URL "${PUBLIC_BASE_URL:-}"
          set_var REQUIRE_INVITE_CODE "${REQUIRE_INVITE_CODE:-}"
          set_var GITHUB_CLIENT_ID "${GITHUB_CLIENT_ID:-}"
          set_var GITHUB_CALLBACK_URL "${GITHUB_CALLBACK_URL:-}"
          set_var GOOGLE_CLIENT_ID "${GOOGLE_CLIENT_ID:-}"
          set_var GOOGLE_CALLBACK_URL "${GOOGLE_CALLBACK_URL:-}"
          set_var LINUXDO_CLIENT_ID "${LINUXDO_CLIENT_ID:-}"
          set_var LINUXDO_CALLBACK_URL "${LINUXDO_CALLBACK_URL:-}"
          set_var LINUXDO_AUTHORIZATION_URL "${LINUXDO_AUTHORIZATION_URL:-}"
          set_var LINUXDO_TOKEN_URL "${LINUXDO_TOKEN_URL:-}"
          set_var LINUXDO_PROFILE_URL "${LINUXDO_PROFILE_URL:-}"
          set_var LINUXDO_SCOPE "${LINUXDO_SCOPE:-}"
